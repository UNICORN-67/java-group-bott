<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Tiranga</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>

    <style>
        :root { --bg: #000; --saffron: #FF9933; --white: #FFF; --green: #138808; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: white; margin: 0; padding: 0; }
        
        #loader { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--saffron); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .screen { display: none; padding: 20px; flex-direction: column; align-items: center; min-height: 100vh; text-align: center; box-sizing: border-box; }
        .active { display: flex; }
        
        .btn { padding: 18px; width: 100%; max-width: 300px; border-radius: 12px; border: none; font-weight: bold; background: linear-gradient(90deg, var(--saffron), var(--white), var(--green)); color: #000; margin-top: 15px; cursor: pointer; text-transform: uppercase; }
        .btn-sec { background: #222; color: #fff; border: 1px solid #444; }

        .lb-card { background: #111; width: 100%; max-width: 350px; border-radius: 15px; padding: 10px; margin-top: 20px; border: 1px solid #333; }
        .lb-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #222; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p id="status" style="margin-top: 20px; color: #888;">SYNCING WITH COMMAND...</p>
    </div>

    <div id="screen-select" class="screen">
        <h1 style="color: var(--saffron);">JOIN THE FORCE</h1>
        <p style="color: #666;">Choose your specialized unit</p>
        <button class="btn" onclick="register('ARMY')">JOIN ARMY</button>
        <button class="btn" onclick="register('NAVY')">JOIN NAVY</button>
        <button class="btn" onclick="register('AIR FORCE')">JOIN AIR FORCE</button>
    </div>

    <div id="screen-dash" class="screen">
        <h2 id="u-name" style="margin-bottom: 0;">OFFICER</h2>
        <p id="u-unit" style="color: var(--saffron); font-weight: bold; margin-top: 5px;"></p>
        
        <div style="background: radial-gradient(circle, #1a1a1a, #000); padding: 40px; border-radius: 50%; border: 3px solid var(--green); margin: 30px 0; box-shadow: 0 0 20px rgba(19, 136, 8, 0.3);">
            <h1 id="u-missions" style="font-size: 4rem; margin: 0;">0</h1>
            <small style="color: #666;">MISSIONS</small>
        </div>

        <button class="btn" onclick="updateMissions()">REPORT DUTY</button>
        <button class="btn btn-sec" onclick="loadLeaderboard()">RANKINGS</button>
    </div>

    <div id="screen-leaderboard" class="screen">
        <h2 style="color: var(--saffron);">TOP OFFICERS</h2>
        <div id="leaderboard-list" class="lb-card">
            </div>
        <button class="btn btn-sec" onclick="show('screen-dash')">BACK</button>
    </div>

    <script>
        const { Client, Databases, Query } = Appwrite;
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // --- APWRITE CONFIG (APKE SCREENSHOT SE VERIFIED) ---
        const client = new Client()
    .setEndpoint('https://fra.cloud.appwrite.io/v1')
    .setProject('697874190033c5037d47'); // Aapki Project ID

const databases = new Databases(client);
const DB_ID = '6978749b001103ca1fdf';    // "Helloo" Database ID
const COLL_ID = 'users';                 // Aapki "Userr" Collection ID
// ---------------------------------------------------
        const USER_ID = tg.initDataUnsafe?.user?.id?.toString() || "tester_123";
        const USER_NAME = tg.initDataUnsafe?.user?.first_name || "OFFICER";

        async function init() {
            try {
                const doc = await databases.getDocument(DB_ID, COLL_ID, USER_ID);
                render(doc);
                show('screen-dash');
            } catch (err) {
                console.log("New User Detected");
                show('screen-select');
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function register(unit) {
            try {
                const data = { name: USER_NAME, unit: unit, missions: 0 };
                await databases.createDocument(DB_ID, COLL_ID, USER_ID, data);
                location.reload();
            } catch (e) {
                alert("Error: " + e.message + "\nCheck if 'name', 'unit', 'missions' columns are created!");
            }
        }

        async function updateMissions() {
            const m = document.getElementById('u-missions');
            const newCount = parseInt(m.innerText) + 1;
            m.innerText = newCount; // Fast UI update
            tg.HapticFeedback.impactOccurred('medium');

            try {
                await databases.updateDocument(DB_ID, COLL_ID, USER_ID, { missions: newCount });
            } catch (e) { console.error("Cloud sync failed"); }
        }

        async function loadLeaderboard() {
            show('loader'); // Temp loader
            try {
                const response = await databases.listDocuments(DB_ID, COLL_ID);
                let users = response.documents;
                users.sort((a, b) => b.missions - a.missions);

                let html = "";
                users.slice(0, 10).forEach((u, i) => {
                    const icon = i === 0 ? "ðŸ¥‡" : i === 1 ? "ðŸ¥ˆ" : i === 2 ? "ðŸ¥‰" : `#${i+1}`;
                    html += `
                        <div class="lb-row">
                            <span>${icon} ${u.name}</span>
                            <span style="color: var(--saffron); font-weight:bold;">${u.missions}</span>
                        </div>`;
                });
                document.getElementById('leaderboard-list').innerHTML = html;
                show('screen-leaderboard');
            } catch (e) { alert("LB Error: " + e.message); }
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        function render(d) {
            document.getElementById('u-name').innerText = d.name.toUpperCase();
            document.getElementById('u-unit').innerText = d.unit;
            document.getElementById('u-missions').innerText = d.missions;
        }

        function show(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if(id !== 'loader') document.getElementById(id).classList.add('active');
        }

        window.onload = init;
    </script>
</body>
</html>
